{% extends 'base.html' %}
{% load common_tags %}

{% block title %}{{ product.title }}{% endblock %}

{% block content %}
<div class="container py-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'products:home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'products:product_list_by_category' product.category.slug %}">{{ product.category.name }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ product.title }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Product Images -->
        <div class="col-lg-5 mb-4 product-gallery">
            <!-- Main Image Container with Zoom functionality -->
            <div class="card">
                <div class="card-body p-2 m-auto position-relative product-image-container" id="img-container">
                    <div class="zoom-icon">
                        <i class="fas fa-search-plus"></i>
                    </div>
                    {% if product.primary_image %}
                    <img src="{{ product.primary_image.image.url }}" alt="{{ product.title }}"
                         class="product-detail-image img-fluid" id="main-product-image">
                    {% else %}
                    <img src="/static/img/no-image.png" alt="{{ product.title }}" class="product-detail-image img-fluid"
                         id="main-product-image">
                    {% endif %}
                </div>
            </div>

            <!-- Image popup modal (lighter, more modern design) -->
            <div class="product-zoom-modal" id="zoom-modal">
                <div class="product-zoom-modal-content">
                    <div class="product-zoom-header">
                        <h5 class="product-zoom-title">{{ product.title }}</h5>
                        <button class="product-zoom-close" id="zoom-close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="product-zoom-body">
                        <img id="zoomed-image" class="product-zoomed-image">
                    </div>
                </div>
            </div>

            <!-- Thumbnails with horizontal scroll (will hide when not needed) -->
            {% if product.images.count > 1 %}
            <div class="mt-3">
                <div class="product-thumbnails-container" id="thumbnails-container">
                    <button class="product-scroll-button product-scroll-left" id="scroll-left">
                        <i class="fas fa-chevron-left"></i>
                    </button>

                    <div class="product-thumbnails-scroll" id="thumbnails-scroll">
                        {% for image in product.images.all %}
                        <div class="product-thumbnail-wrapper">
                            <img src="{{ image.image.url }}" alt="{{ product.title }}"
                                 class="product-thumbnail-image {% if image.is_primary %}active{% endif %}"
                                 data-full-img="{{ image.image.url }}">
                        </div>
                        {% endfor %}
                    </div>

                    <button class="product-scroll-button product-scroll-right" id="scroll-right">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Product Info -->
        <div class="col-lg-7">
            <div class="card mb-4">
                <div class="card-body">
                    <h1 class="h3 mb-2">{{ product.title }}</h1>

                    <div class="d-flex align-items-center mb-3">
                        {% if product.reviews.count > 0 %}
                        {% with avg_rating=product.reviews.all|avg_rating %}
                        {% rating_display avg_rating product.reviews.count %}
                        {% endwith %}
                        {% else %}
                        {% rating_display 0 0 %}
                        {% endif %}
                        <span class="text-muted">|</span>
                        <span class="ms-3 text-muted">
                            Sold by: <a href="{% url 'vendors:vendor_detail' product.vendor.slug %}">{{ product.vendor.business_name }}</a>
                        </span>
                    </div>

                    <div class="product-price mb-3" id="product-price">
                        {% if product.is_on_sale %}
                        <span class="original-price fs-5 text-decoration-line-through">₹{{ product.price }}</span>
                        <span class="fs-3 fw-bold text-primary">₹{{ product.current_price }}</span>
                        <span class="badge bg-danger ms-2">{{ product.discount_percentage }}% OFF</span>
                        {% else %}
                        <span class="fs-3 fw-bold text-primary">₹{{ product.current_price }}</span>
                        {% endif %}
                    </div>

                    <!-- Product variants section -->
                    {% if product.variants.exists %}
                    <div class="mb-4 product-variants">
                        <h5>Options</h5>
                        <div class="variant-selection">
                            {% for attribute in product.variants.all|get_variant_attributes %}
                            <div class="mb-3">
                                <label class="form-label fw-medium">{{ attribute.name }}</label>
                                <div class="variant-options d-flex flex-wrap gap-2 mt-2">
                                    {% for value in attribute.values.all %}
                                    {% if value|has_variant_for_product:product %}
                                    <div class="form-check">
                                        <input type="radio" class="variant-option"
                                               name="{{ attribute.name }}" value="{{ value.id }}"
                                               id="{{ attribute.name }}-{{ value.id }}"
                                               data-attribute="{{ attribute.name }}"
                                               onchange="updateSelectedVariant()"
                                               {% if default_attributes|get_item:attribute.name == value.id %}checked{% endif %}
                                               {% if all_variants_out_of_stock %}disabled{% endif %}>
                                        {% if attribute.name|lower == "color" %}
                                        <label class="color-label" for="{{ attribute.name }}-{{ value.id }}"
                                               style="background-color: {{ value.value|lower }};"></label>
                                        {% else %}
                                        <label class="variant-label" for="{{ attribute.name }}-{{ value.id }}">
                                            {{ value.value }}
                                        </label>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Add to cart form -->
                    <div class="mb-4 d-flex align-items-center">
                        <form action="{% url 'cart:add_to_cart' product.id %}" method="POST" id="add-to-cart-form">
                            {% csrf_token %}

                            {% if product.variants.exists %}
                            <input type="hidden" name="variant_id" id="selected-variant-id">
                            {% endif %}

                            <!-- Quantity selector -->
                            <div class="d-flex align-items-center mb-3">
                                <label class="me-3 fw-medium">Quantity:</label>
                                <div class="quantity-control">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="quantity-minus">−</button>

                                    {% if product.variants.exists %}
                                    <input type="number" name="quantity" value="1" min="1" class="form-control form-control-sm text-center quantity-input" style="width: 60px;">
                                    {% else %}
                                    <input type="number" name="quantity" value="1" min="1" max="{{ product.quantity }}" class="form-control form-control-sm text-center quantity-input" style="width: 60px;">
                                    {% endif %}
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="quantity-plus">+</button>
                                </div>

                                <span id="availability-text" class="ms-3
                                    {% if product.quantity > 10 %}text-success{% elif product.quantity > 0 %}text-warning{% else %}text-danger{% endif %}">
                                    {% if product.quantity > 10 %}
                                        <i class="fas fa-check-circle me-1"></i> In Stock
                                    {% elif product.quantity > 0 %}
                                        <i class="fas fa-exclamation-circle me-1"></i> Only {{ product.quantity }} left!
                                    {% else %}
                                        <i class="fas fa-times-circle me-1"></i> Out of Stock
                                    {% endif %}
                                </span>
                            </div>

                            <!-- Action buttons -->
                            <div class="d-flex">
                                <button type="submit" class="btn btn-primary" {% if not product.is_in_stock %}disabled{% endif %}>
                                    <i class="fas fa-shopping-cart me-2"></i> Add to Cart
                                </button>
                            </div>
                        </form>
                        <form action="{% url 'accounts:toggle_wishlist' product.id %}" method="POST" class="ms-3 mt-auto">
                            {% csrf_token %}
                            <input type="hidden" name="next" value="{{ request.path }}">
                            <button type="submit" class="btn btn-sm btn-icon wishlist-btn{% if user.is_authenticated and product in user.profile.wishlist_products.all %} active{% endif %}">
                                {% if user.is_authenticated and product in user.profile.wishlist_products.all %}
                                <i class="fas fa-heart"></i>
                                {% else %}
                                <i class="far fa-heart"></i>
                                {% endif %}
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Product Description -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Product Description</h5>
                </div>
                <div class="card-body">
                    <div class="product-description">
                        {{ product.description|linebreaks }}
                    </div>
                </div>
            </div>

            <!-- Specifications -->
            {% if product.brand %}
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Specifications</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Brand:</strong> {{ product.brand.name }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Category:</strong> {{ product.category.name }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>SKU:</strong> {{ product.sku }}</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Reviews and Questions Tabs -->
    <div class="card mb-4 border-0 shadow-sm review-questions-tabs">
        <div class="card-header bg-white p-0">
            <ul class="nav nav-tabs card-header-tabs" id="productTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active px-4 py-3" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews"
                            type="button" role="tab" aria-controls="reviews" aria-selected="true">
                        <i class="fas fa-star me-2 text-warning"></i>Reviews <span class="badge rounded-pill bg-secondary ms-1">{{ reviews.count }}</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link px-4 py-3" id="questions-tab" data-bs-toggle="tab" data-bs-target="#questions"
                            type="button" role="tab" aria-controls="questions" aria-selected="false">
                        <i class="fas fa-question-circle me-2 text-primary"></i>Questions <span class="badge rounded-pill bg-secondary ms-1">{{ questions.count }}</span>
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body p-4">
            <div class="tab-content" id="productTabsContent">
                <!-- Reviews Tab -->
                <div class="tab-pane fade show active" id="reviews" role="tabpanel" aria-labelledby="reviews-tab">
                    {% if user.is_authenticated %}
                    <div class="review-form-container mb-4 p-3 bg-light rounded">
                        <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-pencil-alt me-2"></i>Write a Review</h5>
                        <form action="{% url 'products:add_review' product.slug %}" method="POST">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label class="form-label fw-medium">Rating</label>
                                <div class="rating-input d-flex flex-wrap">
                                    {% for i in '12345' %}
                                    <div class="form-check form-check-inline me-3">
                                        <input class="form-check-input" type="radio" name="rating" id="rating{{ i }}"
                                               value="{{ i }}" required>
                                        <label class="form-check-label" for="rating{{ i }}">
                                            <span class="rating-star">{% if forloop.counter <= i|add:"0" %}<i class="fas fa-star text-warning"></i>{% else %}<i class="far fa-star"></i>{% endif %}</span>
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="reviewTitle" class="form-label fw-medium">Title</label>
                                <input type="text" class="form-control" id="reviewTitle" name="title"
                                       placeholder="Summarize your experience with this product">
                            </div>
                            <div class="mb-3">
                                <label for="reviewComment" class="form-label fw-medium">Your Review</label>
                                <textarea class="form-control" id="reviewComment" name="comment" rows="3"
                                          placeholder="What did you like or dislike? How is the quality? Would you recommend it?"
                                          required></textarea>
                                <div class="form-text text-muted">Minimum 10 characters required</div>
                            </div>
                            <div class="d-grid d-md-flex justify-content-md-end">
                                <button type="submit" class="btn btn-primary px-4">
                                    <i class="fas fa-paper-plane me-2"></i>Submit Review
                                </button>
                            </div>
                        </form>
                    </div>
                    {% else %}
                    <div class="alert alert-info d-flex align-items-center mb-4">
                        <i class="fas fa-info-circle me-3 fs-4"></i>
                        <div>
                            <strong>Want to write a review?</strong> <a href="{% url 'account_login' %}?next={{ request.path }}" class="alert-link">Log in</a> or <a href="{% url 'account_signup' %}" class="alert-link">sign up</a> to share your experience.
                        </div>
                    </div>
                    {% endif %}

                    <div class="reviews-section">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0"><i class="fas fa-comments me-2"></i>Customer Reviews</h5>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="reviewSortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    Sort by
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="reviewSortDropdown">
                                    <li><a class="dropdown-item" href="?sort=newest">Newest first</a></li>
                                    <li><a class="dropdown-item" href="?sort=highest">Highest rated</a></li>
                                    <li><a class="dropdown-item" href="?sort=lowest">Lowest rated</a></li>
                                </ul>
                            </div>
                        </div>

                        {% if reviews %}
                        <div class="reviews-list">
                            {% for review in reviews %}
                            <div class="review-item mb-4 p-3 border rounded hover-shadow transition-all">
                                <div class="d-md-flex justify-content-between">
                                    <div class="review-main">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="reviews-stars me-2">
                                                {% display_stars review.rating %}
                                            </div>
                                            {% if review.is_verified_purchase %}
                                            <span class="badge bg-success rounded-pill">
                                            <i class="fas fa-check-circle me-1"></i>Verified Purchase
                                        </span>
                                            {% endif %}
                                        </div>

                                        {% if review.title %}
                                        <h6 class="review-title fw-bold mb-2">{{ review.title }}</h6>
                                        {% endif %}

                                        <div class="review-author text-muted small mb-2">
                                            <i class="fas fa-user me-1"></i>{{ review.user.first_name|default:review.user.email }}
                                        </div>

                                        <div class="review-content mb-2">
                                            {{ review.comment|linebreaks }}
                                        </div>

                                        <div class="review-actions mt-2 d-flex">
                                            <button class="btn btn-sm btn-link text-muted p-0" data-bs-toggle="tooltip" title="Mark as helpful">
                                                <i class="far fa-thumbs-up me-1"></i>Helpful
                                            </button>

                                            {% if user.is_authenticated and user == product.vendor.user %}
                                            <button class="btn btn-sm btn-link text-muted p-0 ms-3" onclick="document.getElementById('vendor-reply-{{ review.id }}').classList.toggle('d-none')">
                                                <i class="fas fa-reply me-1"></i>Reply
                                            </button>
                                            <div id="vendor-reply-{{ review.id }}" class="vendor-reply-form mt-2 d-none">
                                                <form action="#" method="POST" class="d-flex">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="review_id" value="{{ review.id }}">
                                                    <textarea class="form-control form-control-sm me-2" name="reply" rows="1" placeholder="Reply to this review"></textarea>
                                                    <button type="submit" class="btn btn-sm btn-primary">Submit</button>
                                                </form>
                                            </div>
                                            {% endif %}
                                        </div>

                                        {% if review.vendor_reply %}
                                        <div class="vendor-reply mt-3 ms-3 p-2 border-start border-primary bg-light">
                                            <div class="fw-medium"><i class="fas fa-store me-1"></i>Seller response:</div>
                                            <div class="vendor-reply-content">{{ review.vendor_reply }}</div>
                                            <div class="text-muted small mt-1">{{ review.vendor_reply_date|date:"M d, Y" }}</div>
                                        </div>
                                        {% endif %}
                                    </div>

                                    <div class="review-meta text-end text-muted small mt-2 mt-md-0">
                                        {{ review.created_at|date:"M d, Y" }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}

                            <!-- Pagination -->
                            {% if reviews.paginator.num_pages > 1 %}
                            <nav aria-label="Reviews pagination" class="mt-4">
                                <ul class="pagination justify-content-center">
                                    {% if reviews.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ reviews.previous_page_number }}" aria-label="Previous">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                    {% endif %}

                                    {% for i in reviews.paginator.page_range %}
                                    <li class="page-item {% if reviews.number == i %}active{% endif %}">
                                        <a class="page-link" href="?page={{ i }}">{{ i }}</a>
                                    </li>
                                    {% endfor %}

                                    {% if reviews.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ reviews.next_page_number }}" aria-label="Next">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                    {% endif %}
                                </ul>
                            </nav>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="far fa-comment-dots text-muted mb-3" style="font-size: 3rem;"></i>
                            <p class="text-muted">No reviews yet. Be the first to review this product!</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Questions Tab -->
                <div class="tab-pane fade" id="questions" role="tabpanel" aria-labelledby="questions-tab">
                    {% if user.is_authenticated %}
                    <div class="question-form-container mb-4 p-3 bg-light rounded">
                        <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-question me-2"></i>Ask a Question</h5>
                        <form action="{% url 'products:ask_question' product.slug %}" method="POST">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="questionText" class="form-label fw-medium">Your Question</label>
                                <textarea class="form-control" id="questionText" name="question" rows="2"
                                          placeholder="What would you like to know about this product?"
                                          required></textarea>
                                <div class="form-text text-muted">Be specific to get better answers</div>
                            </div>
                            <div class="d-grid d-md-flex justify-content-md-end">
                                <button type="submit" class="btn btn-primary px-4">
                                    <i class="fas fa-paper-plane me-2"></i>Submit Question
                                </button>
                            </div>
                        </form>
                    </div>
                    {% else %}
                    <div class="alert alert-info d-flex align-items-center mb-4">
                        <i class="fas fa-info-circle me-3 fs-4"></i>
                        <div>
                            <strong>Have a question?</strong> <a href="{% url 'account_login' %}?next={{ request.path }}" class="alert-link">Log in</a> or <a href="{% url 'account_signup' %}" class="alert-link">sign up</a> to ask about this product.
                        </div>
                    </div>
                    {% endif %}

                    <div class="questions-section">
                        <h5 class="mb-3"><i class="fas fa-comment-dots me-2"></i>Questions & Answers</h5>

                        {% if questions %}
                        <div class="questions-list">
                            {% for question in questions %}
                            <div class="question-item mb-4 p-3 border rounded hover-shadow transition-all">
                                <div class="question-header d-flex justify-content-between align-items-start mb-2">
                                    <div class="question-content">
                                        <div class="fw-bold mb-1">
                                            <i class="fas fa-question-circle text-primary me-2"></i>{{ question.question }}
                                        </div>
                                        <div class="question-meta d-flex flex-wrap gap-2 text-muted small mb-3">
                                            <span><i class="fas fa-user me-1"></i>{{ question.user.first_name|default:question.user.email }}</span>
                                            <span><i class="far fa-calendar me-1"></i>{{ question.created_at|date:"M d, Y" }}</span>
                                        </div>
                                    </div>
                                </div>

                                {% if question.answers.exists %}
                                <div class="answers-list ps-md-4 mb-3 border-start border-light">
                                    {% for answer in question.answers.all %}
                                    <div class="answer-item mb-3 p-2 {% if answer.is_vendor %}bg-light rounded{% endif %}">
                                        <div class="answer-content">
                                            <div class="fw-medium mb-1">
                                                <i class="fas fa-reply text-success me-2"></i>{{ answer.answer }}
                                            </div>
                                            <div class="answer-meta d-flex flex-wrap gap-2 text-muted small">
                                            <span>
                                                {% if answer.is_vendor %}
                                                <span class="badge bg-primary rounded-pill me-1"><i class="fas fa-store me-1"></i>Seller</span>
                                                {% endif %}
                                                {{ answer.user.first_name|default:answer.user.email }}
                                            </span>
                                                <span><i class="far fa-calendar me-1"></i>{{ answer.created_at|date:"M d, Y" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}

                                {% if user.is_authenticated %}
                                <div class="answer-action mt-2">
                                    <button class="btn btn-sm btn-outline-secondary"
                                            onclick="document.getElementById('answer-form-{{ question.id }}').classList.toggle('d-none')">
                                        <i class="fas fa-reply me-1"></i>Answer this question
                                    </button>
                                    <form action="{% url 'products:answer_question' question.id %}" method="POST"
                                          class="answer-form mt-2 d-none" id="answer-form-{{ question.id }}">
                                        {% csrf_token %}
                                        <div class="input-group">
                                        <textarea class="form-control" name="answer" rows="2"
                                                  placeholder="Your answer" required></textarea>
                                            <button type="submit" class="btn btn-primary">Submit</button>
                                        </div>
                                    </form>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}

                            <!-- Questions Pagination -->
                            {% if questions.paginator.num_pages > 1 %}
                            <nav aria-label="Questions pagination" class="mt-4">
                                <ul class="pagination justify-content-center">
                                    {% if questions.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?tab=questions&page={{ questions.previous_page_number }}" aria-label="Previous">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                    {% endif %}

                                    {% for i in questions.paginator.page_range %}
                                    <li class="page-item {% if questions.number == i %}active{% endif %}">
                                        <a class="page-link" href="?tab=questions&page={{ i }}">{{ i }}</a>
                                    </li>
                                    {% endfor %}

                                    {% if questions.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?tab=questions&page={{ questions.next_page_number }}" aria-label="Next">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                    {% endif %}
                                </ul>
                            </nav>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="far fa-question-circle text-muted mb-3" style="font-size: 3rem;"></i>
                            <p class="text-muted">No questions yet. Ask the first question about this product!</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Related Products -->
    {% if related_products %}
    <div class="related-products">
        <h3 class="mb-3">Related Products</h3>
        <div class="row g-4">
            {% for product in related_products %}
            <div class="col-md-3 col-6">
                {% include 'products/includes/product_card.html' %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Personalized Recommendations -->
    {% if personalized_recommendations %}
    <div class="personalized-recommendations mt-5">
        <h3 class="mb-3">You Might Also Like</h3>
        <div class="row g-4">
            {% for product in personalized_recommendations %}
            <div class="col-md-3 col-6">
                {% include 'products/includes/product_card.html' %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Store variant data from View
const productVariants = {{ variants_json|safe }};

// Function to update the selected variant based on user selections
function updateSelectedVariant() {
    if (!productVariants || productVariants.length === 0) {
        return;
    }

    const variantOptions = document.querySelectorAll('.variant-option:checked');
    const selectedAttributes = {};
    variantOptions.forEach(option => {
        selectedAttributes[option.getAttribute('data-attribute')] = option.value;
    });

    const matchingVariant = findMatchingVariant(selectedAttributes);
    const variantIdInput = document.getElementById('selected-variant-id');
    const addToCartBtn = document.querySelector('#add-to-cart-form button[type="submit"]');
    const hasAvailableVariants = productVariants.some(variant => variant.is_in_stock);

    if (matchingVariant) {
        variantIdInput.value = matchingVariant.id;
        updateAvailabilityText(matchingVariant);
        updatePriceDisplay(matchingVariant);
        updateQuantityInput(matchingVariant);
        if (addToCartBtn) addToCartBtn.disabled = !matchingVariant.is_in_stock;
    } else {
        variantIdInput.value = '';
        const availabilityText = document.getElementById('availability-text');
        if (availabilityText) {
            if (hasAvailableVariants) {
                availabilityText.innerHTML = '<i class="fas fa-times-circle me-1"></i> This combination is not available';
            } else {
                availabilityText.innerHTML = '<i class="fas fa-times-circle me-1"></i> All variants are out of stock';
            }
            availabilityText.className = 'ms-3 text-danger';
        }
        if (addToCartBtn) addToCartBtn.disabled = true;
        const priceDisplay = document.getElementById('product-price');
        if (priceDisplay) {
            priceDisplay.innerHTML = `₹${parseFloat('{{ product.current_price }}').toFixed(2)}`;
        }
    }
}

// Find the variant that matches the selected attributes
function findMatchingVariant(selectedAttributes) {
    return productVariants.find(variant => {
        return Object.entries(selectedAttributes).every(([attrName, attrValueId]) => {
            return variant.attributes[attrName] === parseInt(attrValueId, 10);
        });
    });
}

// Update the availability text based on the selected variant
function updateAvailabilityText(variant) {
    const availabilityText = document.getElementById('availability-text');
    if (!availabilityText) return;

    if (variant.is_in_stock) {
        if (variant.quantity > 10) {
            availabilityText.innerHTML = '<i class="fas fa-check-circle me-1"></i> In Stock';
            availabilityText.className = 'ms-3 text-success';
        } else {
            availabilityText.innerHTML = `<i class="fas fa-exclamation-circle me-1"></i> Only ${variant.quantity} left!`;
            availabilityText.className = 'ms-3 text-warning';
        }
    } else {
        availabilityText.innerHTML = '<i class="fas fa-times-circle me-1"></i> Out of Stock';
        availabilityText.className = 'ms-3 text-danger';
    }


    const addToCartBtn = document.querySelector('#add-to-cart-form button[type="submit"]');
    if (addToCartBtn) {
        addToCartBtn.disabled = !variant.is_in_stock;
    }
}

// Update the price display based on the selected variant
function updatePriceDisplay(variant) {
    const priceDisplay = document.getElementById('product-price');
    if (!priceDisplay) return;

    let priceHTML = '';
    if (variant.is_on_sale) {
        priceHTML = `
            <span class="original-price fs-5 text-decoration-line-through">₹${variant.price.toFixed(2)}</span>
            <span class="fs-3 fw-bold text-primary">₹${variant.sale_price.toFixed(2)}</span>
            <span class="badge bg-danger ms-2">${variant.discount_percentage}% OFF</span>
        `;
    } else {
        priceHTML = `<span class="fs-3 fw-bold text-primary">₹${variant.price.toFixed(2)}</span>`;
    }
    priceDisplay.innerHTML = priceHTML;
}

// Update the quantity input maximum based on the selected variant
function updateQuantityInput(variant) {
    const quantityInput = document.querySelector('.quantity-input');
    if (!quantityInput) return;

    quantityInput.max = variant.quantity;
    if (parseInt(quantityInput.value) > variant.quantity) {
        quantityInput.value = Math.max(1, variant.quantity);
    }
}

// Handle quantity buttons
document.addEventListener('DOMContentLoaded', function() {
    const quantityInput = document.querySelector('.quantity-input');
    const minusBtn = document.getElementById('quantity-minus');
    const plusBtn = document.getElementById('quantity-plus');

    if (quantityInput && minusBtn && plusBtn) {
        minusBtn.addEventListener('click', function() {
            const currentVal = parseInt(quantityInput.value);
            if (currentVal > 1) {
                quantityInput.value = currentVal - 1;
            }
        });

        plusBtn.addEventListener('click', function() {
            const currentVal = parseInt(quantityInput.value);
            const max = parseInt(quantityInput.max) || 99;
            if (currentVal < max) {
                quantityInput.value = currentVal + 1;
            }
        });
    }

    // Image gallery functionality
    const thumbnails = document.querySelectorAll('.thumbnail-image');
    const mainImage = document.getElementById('main-product-image');
    if (thumbnails.length > 0 && mainImage) {
        thumbnails.forEach(thumbnail => {
            thumbnail.addEventListener('click', function() {
                thumbnails.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                mainImage.src = this.src;
            });
        });
    }

    // Initialize variant selection
    updateSelectedVariant();
});


document.getElementById('add-to-cart-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const variantIdElement = document.getElementById('selected-variant-id');
    const quantity = parseInt(document.querySelector('.quantity-input').value);

    if (variantIdElement) {
        const variantId = variantIdElement.value;
        if(variantId){
            fetch(`/check-variant-quantity/${variantId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.quantity >= quantity) {
                        this.submit();
                    } else {
                        alert(`Only ${data.quantity} items left in stock.`);
                        updateAvailabilityText({ quantity: data.quantity, is_in_stock: data.quantity > 0 });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    this.submit(); // Fallback to server-side validation
                });
            }
    } else {
        this.submit(); // No variant selected, proceed normally
    }
});

 // Image zoom functionality
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('img-container');
    const mainImg = document.getElementById('main-product-image');
    const zoomModal = document.getElementById('zoom-modal');
    const zoomedImg = document.getElementById('zoomed-image');
    const closeBtn = document.getElementById('zoom-close');

    if (container && mainImg && zoomModal && zoomedImg) {
        // Open zoom modal when clicking on the main image
        container.addEventListener('click', function() {
            zoomModal.style.display = 'block';
            zoomedImg.src = mainImg.src;
            document.body.style.overflow = 'hidden'; // Prevent scrolling when modal is open

            // Reset zoom level and position when opening modal
            scale = 1;
            currentTranslate = { x: 0, y: 0 };
            zoomedImg.style.transform = '';
        });

        // Close modal when clicking the close button
        if (closeBtn) {
            closeBtn.addEventListener('click', function() {
                zoomModal.style.display = 'none';
                document.body.style.overflow = 'auto'; // Restore scrolling
            });
        }

        // Close modal when clicking outside the image in the modal
        zoomModal.addEventListener('click', function(e) {
            if (e.target === zoomModal) {
                zoomModal.style.display = 'none';
                document.body.style.overflow = 'auto'; // Restore scrolling
            }
        });

        // Close modal when pressing ESC key (for accessibility)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && zoomModal.style.display === 'block') {
                zoomModal.style.display = 'none';
                document.body.style.overflow = 'auto'; // Restore scrolling
            }
        });

        // Variables for pan/zoom functionality
        let scale = 1;
        let currentTranslate = { x: 0, y: 0 };
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let lastTap = 0; // For double-tap detection on mobile

        // Mouse wheel zoom
        zoomedImg.addEventListener('wheel', function(e) {
            e.preventDefault();

            // Get mouse position
            const rect = zoomedImg.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            // Determine zoom direction
            const delta = e.deltaY > 0 ? -0.1 : 0.1;

            // Calculate new scale
            const newScale = Math.min(Math.max(0.5, scale + delta), 3);

            // Get scale factor
            const factor = newScale / scale;

            // Calculate new translate values to zoom toward mouse pointer
            currentTranslate.x = mouseX - (mouseX - currentTranslate.x * scale) / (scale * factor);
            currentTranslate.y = mouseY - (mouseY - currentTranslate.y * scale) / (scale * factor);

            // Update scale
            scale = newScale;

            // Apply transformation
            zoomedImg.style.transform = `scale(${scale}) translate(${currentTranslate.x}px, ${currentTranslate.y}px)`;
        });

        // Mouse drag functionality for panning
        zoomedImg.addEventListener('mousedown', function(e) {
            if (scale > 1) {
                isDragging = true;
                dragStart.x = e.clientX;
                dragStart.y = e.clientY;
                zoomedImg.style.cursor = 'grabbing';
            }
        });

        document.addEventListener('mousemove', function(e) {
            if (isDragging && scale > 1) {
                e.preventDefault();

                const dx = e.clientX - dragStart.x;
                const dy = e.clientY - dragStart.y;

                currentTranslate.x += dx / scale;
                currentTranslate.y += dy / scale;

                zoomedImg.style.transform = `scale(${scale}) translate(${currentTranslate.x}px, ${currentTranslate.y}px)`;

                dragStart.x = e.clientX;
                dragStart.y = e.clientY;
            }
        });

        document.addEventListener('mouseup', function() {
            isDragging = false;
            if (zoomedImg) zoomedImg.style.cursor = 'grab';
        });

        // Double-click to reset zoom
        zoomedImg.addEventListener('dblclick', function() {
            scale = 1;
            currentTranslate = { x: 0, y: 0 };
            zoomedImg.style.transform = '';
        });

        // Touch events for mobile
        zoomedImg.addEventListener('touchstart', function(e) {
            // Double tap detection
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;

            if (tapLength < 300 && tapLength > 0) {
                // Double tap detected - reset zoom
                scale = 1;
                currentTranslate = { x: 0, y: 0 };
                zoomedImg.style.transform = '';
                e.preventDefault();
            } else if (e.touches.length === 2) {
                // Pinch-to-zoom start
                e.preventDefault();
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];

                // Store initial distance
                const initialDistance = getDistance(touch1, touch2);

                // Store initial touches and scale
                this._initialDistance = initialDistance;
                this._initialScale = scale;
            } else if (e.touches.length === 1 && scale > 1) {
                // Pan start with one finger when zoomed in
                isDragging = true;
                dragStart.x = e.touches[0].clientX;
                dragStart.y = e.touches[0].clientY;
            }

            lastTap = currentTime;
        });

        zoomedImg.addEventListener('touchmove', function(e) {
            if (e.touches.length === 2) {
                // Pinch-to-zoom move
                e.preventDefault();

                const touch1 = e.touches[0];
                const touch2 = e.touches[1];

                const currentDistance = getDistance(touch1, touch2);

                // Calculate new scale based on distance change
                const newScale = Math.min(Math.max(0.5, this._initialScale * (currentDistance / this._initialDistance)), 3);

                // Update scale
                scale = newScale;

                // Apply transformation
                zoomedImg.style.transform = `scale(${scale}) translate(${currentTranslate.x}px, ${currentTranslate.y}px)`;
            } else if (e.touches.length === 1 && isDragging && scale > 1) {
                // Pan move with one finger when zoomed in
                e.preventDefault();

                const dx = e.touches[0].clientX - dragStart.x;
                const dy = e.touches[0].clientY - dragStart.y;

                currentTranslate.x += dx / scale;
                currentTranslate.y += dy / scale;

                zoomedImg.style.transform = `scale(${scale}) translate(${currentTranslate.x}px, ${currentTranslate.y}px)`;

                dragStart.x = e.touches[0].clientX;
                dragStart.y = e.touches[0].clientY;
            }
        });

        zoomedImg.addEventListener('touchend', function() {
            isDragging = false;
        });

        // Helper function to calculate distance between two touch points
        function getDistance(touch1, touch2) {
            const dx = touch1.clientX - touch2.clientX;
            const dy = touch1.clientY - touch2.clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }
    }

    // Horizontal Scroll Functionality for Thumbnails
    const thumbnailsContainer = document.getElementById('thumbnails-container');
    const scrollContainer = document.getElementById('thumbnails-scroll');
    const leftBtn = document.getElementById('scroll-left');
    const rightBtn = document.getElementById('scroll-right');
    const thumbnails = document.querySelectorAll('.product-thumbnail-image');

    if (scrollContainer && leftBtn && rightBtn && thumbnailsContainer) {
        // Check if scrolling is needed
        function checkScrollNeeded() {
            const isScrollNeeded = scrollContainer.scrollWidth > scrollContainer.clientWidth;

            // Add/remove class that hides scroll buttons when not needed
            thumbnailsContainer.classList.toggle('no-scroll-needed', !isScrollNeeded);

            if (isScrollNeeded) {
                // Update scroll buttons state
                updateScrollButtons();
            } else {
                // Center thumbnails when they fit without scrolling
                scrollContainer.style.justifyContent = 'center';
            }
        }

        // Update scroll buttons state
        function updateScrollButtons() {
            // Left button is disabled if scrolled all the way to the left
            leftBtn.classList.toggle('hidden', scrollContainer.scrollLeft <= 0);

            // Right button is disabled if scrolled all the way to the right
            const maxScrollLeft = scrollContainer.scrollWidth - scrollContainer.clientWidth;
            rightBtn.classList.toggle('hidden', scrollContainer.scrollLeft >= maxScrollLeft - 5);
        }

        // Scroll left/right when buttons are clicked
        leftBtn.addEventListener('click', () => {
            const thumbnailWidth = thumbnails[0].offsetWidth + 10; // 10px is the gap
            scrollContainer.scrollBy({ left: -thumbnailWidth * 2, behavior: 'smooth' });
        });

        rightBtn.addEventListener('click', () => {
            const thumbnailWidth = thumbnails[0].offsetWidth + 10; // 10px is the gap
            scrollContainer.scrollBy({ left: thumbnailWidth * 2, behavior: 'smooth' });
        });

        // Update button states when scrolling
        scrollContainer.addEventListener('scroll', updateScrollButtons);

        // Check if scrolling is needed when page loads and when window resizes
        checkScrollNeeded();
        window.addEventListener('resize', checkScrollNeeded);

        // Enable touch scrolling with mouse drag (for desktop)
        let isDown = false;
        let startX;
        let scrollLeft;

        scrollContainer.addEventListener('mousedown', (e) => {
            isDown = true;
            scrollContainer.style.cursor = 'grabbing';
            startX = e.pageX - scrollContainer.offsetLeft;
            scrollLeft = scrollContainer.scrollLeft;
        });

        scrollContainer.addEventListener('mouseleave', () => {
            isDown = false;
            scrollContainer.style.cursor = 'grab';
        });

        scrollContainer.addEventListener('mouseup', () => {
            isDown = false;
            scrollContainer.style.cursor = 'grab';
        });

        scrollContainer.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - scrollContainer.offsetLeft;
            const walk = (x - startX) * 1.5; // Scroll speed multiplier
            scrollContainer.scrollLeft = scrollLeft - walk;
            updateScrollButtons();
        });
    }

    // Thumbnail click functionality
    if (thumbnails.length > 0 && mainImg) {
        thumbnails.forEach(thumbnail => {
            thumbnail.addEventListener('click', function() {
                // Update main image
                const fullImg = this.getAttribute('data-full-img');
                mainImg.src = fullImg;

                // Update active thumbnail
                thumbnails.forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                // If zoomed image is visible, update it too
                if (zoomedImg && zoomModal.style.display === 'block') {
                    zoomedImg.src = fullImg;

                    // Reset zoom when changing image
                    scale = 1;
                    currentTranslate = { x: 0, y: 0 };
                    zoomedImg.style.transform = '';
                }
            });

            // Add keyboard navigation for accessibility
            thumbnail.setAttribute('tabindex', '0'); // Make focusable
            thumbnail.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        });
    }
});

</script>
{% endblock %}
